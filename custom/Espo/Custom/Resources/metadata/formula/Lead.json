{
    "beforeSaveCustomScript": "// Check if the custom contact link is present\n// Trigger only when 'Existing Customer' is selected or changed\nifThen(\n    entity\\isAttributeChanged('cContactId') && cContactId != null,\n    \n    // Personal Details Mapping\n    firstName = cContact.firstName;\n    lastName = cContact.lastName;\n    middleName = cContact.middleName;\n    emailAddress = cContact.emailAddress;\n    phoneNumber = cContact.phoneNumber;\n    \n    // Identity & Demographic Mapping (Based on your screenshots)\n    cNICNo = cContact.cNICNumber;\n    cDateOfBirth = cContact.cDateOfBirth;\n    cGender = cContact.cGender;\n    \n    // Address Mapping\n    addressStreet = cContact.addressStreet;\n    addressCity = cContact.addressCity;\n    addressState = cContact.addressState;\n    addressCountry = cContact.addressCountry;\n    addressPostalCode = cContact.addressPostalCode;\n    \n    // Branch Mapping (Copying the Link)\n    cBranchId = cContact.cBranchId;\n    cBranchName = cContact.cBranchName;\n\n    // Ensure the Lead record has a visible name in lists\n    name = string\\concatenate(firstName, ' ', lastName);\n);\n\n$P = cDesiredLoanAmount; \n$annualRate = 18; \n$r = 0.015; // Monthly interest rate (18% / 12 / 100)\n$n = cPreferredTenure;\n\nifThen(\n    cDesiredLoanAmount > 0 && cPreferredTenure > 0,\n    (\n        $powerVal = number\\power(1 + $r, $n);\n        $numerator = $P * $r * $powerVal;\n        $denominator = $powerVal - 1;\n\n        ifThenElse(\n            $denominator > 0,\n            (\n                $emiVal = $numerator / $denominator;\n                cCalculatedEMI = number\\round($emiVal, 2); \n                cProposedEMI = cCalculatedEMI; \n                \n                description = string\\concatenate('EMI Result: Rs. ', number\\format(cCalculatedEMI, 2));\n            ),\n            (\n                description = 'ERROR: Tenure results in a zero denominator.';\n            )\n        );\n    )\n);\n\n// 1. FINANCIAL ASSESSMENT (FOIR & DTI)\n// Trigger only if EMI, Income, and Obligations are present\nifThen(\n    cProposedEMI > 0 && cTurnover > 0 && cExistingMonthlyObligations >= 0,\n    (\n        cFOIR = number\\round((cProposedEMI / cTurnover) * 100, 2);\n        $totalObligations = cExistingMonthlyObligations + cProposedEMI;\n        cDTI = number\\round(($totalObligations / cTurnover) * 100, 2);\n\n        // 2. AUTO-QUALIFICATION CHECK\n        ifThenElse(\n            cFOIR < 60 && cDTI < 50,\n            (\n                cFinancialQualification = 'Pass';\n                \n                // 3. MAXIMUM ELIGIBILITY CALCULATION\n                $maxTotalEMI = cTurnover * 0.50; \n                $availableEMI = $maxTotalEMI - cExistingMonthlyObligations;\n                \n                $r = 0.015; // 18% / 12 / 100\n                $n = cPreferredTenure;\n                \n                ifThen(\n                    $n > 0,\n                    (\n                        $powerVal = number\\power(1 + $r, $n);\n                        $factor = ($powerVal - 1) / ($r * $powerVal);\n                        cMaxEligibleAmount = number\\round($availableEMI * $factor, 0);\n                    )\n                );\n\n                description = string\\concatenate(description, ' | FIN: PASS. Max Loan: ', number\\format(cCMaxEligibleAmount, 0));\n            ),\n            (\n                cFinancialQualification = 'Fail';\n                cMaxEligibleAmount = 0;\n                description = string\\concatenate(description, ' | FIN: FAIL. FOIR: ', number\\format(cFOIR, 2), '%');\n            )\n        )\n    )\n);\n\n// LEAD SCORE CALCULATION\n$score = 0;\n// CONTACT INFORMATION (30 points)\nifThen(phoneNumber, $score = $score + 15);\nifThen(emailAddress, $score = $score + 10);\nifThen(addressCity && addressState, $score = $score + 5);\n// FINANCIAL INFORMATION (40 points)\nifThen(cDesiredLoanAmount, $score = $score + 10);\nifThen(cTurnover, $score = $score + 15);\nifThen(cEmployeeType, $score = $score + 10);\nifThen(cExistingMonthlyObligations >= 0, $score = $score + 5);\n// DOCUMENTATION (15 points)\nifThen(cNICNo, $score = $score + 10);\nifThen(cDateOfBirth, $score = $score + 5);\n// SOURCE QUALITY (15 points)\nifThen(source == 'Web Site', $score = $score + 5);\nifThen(source == 'Existing Customer', $score = $score + 15);\nifThen(source == 'Partner', $score = $score + 10);\nifThen(source == 'Call', $score = $score + 3);\n// BONUS: Good CRIB score\nifThen(cCreditScore >= 700, $score = $score + 10);\n// Cap at 100\nifThen($score > 100, $score = 100);\n// Store score\ncLeadScore = $score;\ncScoreLastUpdated = datetime\\now();\n\n// STATUS AUTO SET TO QUALIFIED\nifThen(\nstatus == 'Verified' &&\ncCreditScore >= 650 &&\ncFinancialQualification == 'Pass' &&\ncFOIR < 60 &&\ncDTI < 50,\nstatus = 'Qualified';\n);\n\n\n// REFERAL NUMBER\n// Change $autoIncrimentNo and $referalNo values as per the module fields\n$autoIncrimentNo = cLeadID\n$referalNo = cLeadNumber\n$datePart = datetime\\format(datetime\\today(), 'DD/MM/YYYY');\n$incrValue = $autoIncrimentNo % 10000;\nifThen($incrValue == 0, $incrValue = 1);\n$paddedNumber = string\\pad($incrValue, 5, '0', 'left');\n$referalNo = string\\concatenate('L', $datePart, $paddedNumber);"
}