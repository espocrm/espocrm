{
    "beforeSaveCustomScript": "// ==========================================\n// PART 1: MAPPING (Existing Customer)\n// ==========================================\nifThen(\n    cCustomerSegment == 'Existing Customer' && cContactId != null,\n    \n    // Personal Details Mapping\n    firstName = cContact.firstName;\n    lastName = cContact.lastName;\n    middleName = cContact.middleName;\n    emailAddress = cContact.emailAddress;\n    phoneNumber = cContact.phoneNumber;\n    \n    // Identity & Demographic Mapping\n    cNICNo = cContact.cNICNumber;\n    cDateOfBirth = cContact.cDateOfBirth;\n    cGender = cContact.cGender;\n    \n    // Address Mapping\n    addressStreet = cContact.addressStreet;\n    addressCity = cContact.addressCity;\n    addressState = cContact.addressState;\n    addressCountry = cContact.addressCountry;\n    addressPostalCode = cContact.addressPostalCode;\n    \n    // Branch Mapping (Copying the Link)\n    cBranchId = cContact.cBranchId;\n    cBranchName = cContact.cBranchName;\n\n    // Ensure the Lead record has a visible name in lists\n    name = string\\concatenate(firstName, ' ', lastName)\n);\n\n// ==========================================\n// PART 2: REFERRAL NUMBER (CRASH FIXED)\n// ==========================================\n\n// CRITICAL FIX: Use 'number' (Integer) instead of 'cLeadID' (String)\n// The system 'number' field increments automatically (1, 2, 3...)\n$autoIncrimentNo = number;\n\n// SAFETY RULE 1: Handle New Records\n// New records might not have a number yet. We treat them as 0 to prevent crash.\nif ($autoIncrimentNo == null) {\n    $autoIncrimentNo = 0;\n}\n\n// SAFETY RULE 2: Calculate safely\n// Now we are doing math on a real integer, so it won't crash.\n$incrValue = $autoIncrimentNo % 10000;\n\n// SAFETY RULE 3: Handle the '0' case\nifThen($incrValue == 0, $incrValue = 1);\n\n// Generate the final string\n$datePart = datetime\\format(datetime\\today(), 'DD/MM/YYYY');\n$paddedNumber = string\\pad($incrValue, 5, '0', 'left');\n\n// Output to your custom field\n// Note: Ensure 'cLeadNumber' is the correct field name in Entity Manager\ncLeadNumber = string\\concatenate('L', $datePart, $paddedNumber);\n\nif (status == 'Converted') {\n    cIsConvertedInt = 1;\n    cConversionScore = 100;\n} else {\n    cIsConvertedInt = 0;\n    cConversionScore = 0;\n}\n\nif ( status == 'Qualified' || status == 'Converted'){\n    cIsQualified = 1;\n}else{\n    cIsQualified = 0;\n}\n\n",
    "beforeSaveApiScript": null
}