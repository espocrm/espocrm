{
    "beforeSaveCustomScript": "// Check if the custom contact link is present\n// Trigger only when 'Existing Customer' is selected or changed\nifThen(\n    entity\\isAttributeChanged('cContactId') && cContactId != null,\n    \n    // Personal Details Mapping\n    firstName = cContact.firstName;\n    lastName = cContact.lastName;\n    middleName = cContact.middleName;\n    emailAddress = cContact.emailAddress;\n    phoneNumber = cContact.phoneNumber;\n    \n    // Identity & Demographic Mapping (Based on your screenshots)\n    cNICNo = cContact.cNICNumber;\n    cDateOfBirth = cContact.cDateOfBirth;\n    cGender = cContact.cGender;\n    \n    // Address Mapping\n    addressStreet = cContact.addressStreet;\n    addressCity = cContact.addressCity;\n    addressState = cContact.addressState;\n    addressCountry = cContact.addressCountry;\n    addressPostalCode = cContact.addressPostalCode;\n    \n    // Branch Mapping (Copying the Link)\n    cBranchId = cContact.cBranchId;\n    cBranchName = cContact.cBranchName;\n\n    // Ensure the Lead record has a visible name in lists\n    name = string\\concatenate(firstName, ' ', lastName);\n);\n\n// // TEST 1: Check if the system recognizes the income field\n// $rawIncome = cMonthlyIncome;\n\n// description = string\\concatenate(\n//     \"--- DEBUG TEST ---\",\n//     \"\\nIncome Found: \", string\\cast($rawIncome, 'string')\n// );\n\n// // --- 1. CAPTURE RAW INPUTS ---\n// $rawIncome = cMonthlyIncome;\n// $rawLoan = cDesiredLoanAmount;\n// $rawExisting = cExistingMonthlyObligations;\n\n// // --- 2. CALCULATE EMI (Base Calculation) ---\n// $interestRate = 10;\n// $tenureMonths = 12;\n// $emiResult = 0;\n\n// if ($rawLoan > 0) {\n//     $monthlyRate = ($interestRate / 100) / 12;\n//     $pow = math\\pow(1 + $monthlyRate, $tenureMonths);\n//     $emiResult = ($rawLoan * $monthlyRate * $pow) / ($pow - 1);\n//     cProposedEMI = $emiResult;\n// } else {\n//     cProposedEMI = 0;\n// }\n\n// // --- 3. RATIO CALCULATIONS ---\n// if ($rawIncome > 0) {\n//     cFOIR = ($emiResult / $rawIncome) * 100;\n//     cDTI = (($rawExisting + $emiResult) / $rawIncome) * 100;\n// } else {\n//     cFOIR = 0;\n//     cDTI = 0;\n// }\n\n// // --- 4. QUALIFICATION LOGIC ---\n// if (cDTI > 60 || cCRIBStatus == 'Defaults') {\n//     cFinancialQualification = 'Fail';\n// } else if (cDTI > 0 && cDTI <= 60 && cCRIBStatus == 'Clean') {\n//     cFinancialQualification = 'Pass';\n// } else {\n//     cFinancialQualification = 'Pending';\n// }\n\n// // --- 5. DEBUG LOGGING (The \"Console\") ---\n// // This writes the values to the Description field so you can see what happened.\n// description = string\\concatenate(\n//     \"--- LOG START (\" , datetime\\today(), \") ---\",\n//     \"\\nInput Income: \", string\\cast($rawIncome, 'string'),\n//     \"\\nInput Loan: \", string\\cast($rawLoan, 'string'),\n//     \"\\nInput Existing Debt: \", string\\cast($rawExisting, 'string'),\n//     \"\\nCalculated EMI: \", string\\cast($emiResult, 'string'),\n//     \"\\nCalculated DTI: \", string\\cast(cDTI, 'string'),\n//     \"\\nCRIB Status: \", string\\cast(cCRIBStatus, 'string'),\n//     \"\\n--- LOG END ---\"\n// );\n\n// // Updates the timestamp from your documentation [cite: 14, 17]\n// scoreLastUpdated = datetime\\now();\n\n// If this works, your Description will change to \"System is Active\"\n// description = \"System is Active. The formula triggered at: \" + string\\cast(datetime\\now(), 'string');"
}